From 579ec3955ef7297650d60472abe39a3a708a07ed Mon Sep 17 00:00:00 2001
From: Julien Enselme <julien.enselme@ioda.net>
Date: Fri, 17 Feb 2017 16:50:54 +0100
Subject: [PATCH 6/8] Add GML2 MultiLineString serialiazer

---
 src/ol/format/gml2.js           | 57 +++++++++++++++++++++++++++++++++++++++++
 test/spec/ol/format/gml.test.js | 31 ++++++++++++++++++++++
 2 files changed, 88 insertions(+)

diff --git a/src/ol/format/gml2.js b/src/ol/format/gml2.js
index 32c878e..b4a66c7 100644
--- a/src/ol/format/gml2.js
+++ b/src/ol/format/gml2.js
@@ -488,6 +488,17 @@ ol.format.GML2.prototype.getCoords_ = function(point, opt_srsName) {
  * @private
  */
 ol.format.GML2.prototype.writeMultiCurveOrLineString_ = function(node, geometry, objectStack) {
+  var context = objectStack[objectStack.length - 1];
+  var srsName = context['srsName'];
+  var curve = context['curve'];
+  if (srsName) {
+    node.setAttribute('srsName', srsName);
+  }
+  var lines = geometry.getLineStrings();
+  ol.xml.pushSerializeAndPop({node: node, srsName: srsName, curve: curve},
+      ol.format.GML2.LINESTRINGORCURVEMEMBER_SERIALIZERS_,
+      this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_, lines,
+      objectStack, undefined, this);
 };
 
 
@@ -552,6 +563,11 @@ ol.format.GML2.prototype.writePointMember_ = function(node, point, objectStack)
  * @private
  */
 ol.format.GML2.prototype.writeLineStringOrCurveMember_ = function(node, line, objectStack) {
+  var child = this.GEOMETRY_NODE_FACTORY_(line, objectStack);
+  if (child) {
+    node.appendChild(child);
+    this.writeCurveOrLineString_(child, line, objectStack);
+  }
 };
 
 
@@ -648,3 +664,44 @@ ol.format.GML2.POINTMEMBER_SERIALIZERS_ = {
         ol.format.GML2.prototype.writePointMember_)
   }
 };
+
+
+/**
+ * @type {Object.<string, Object.<string, ol.XmlSerializer>>}
+ * @private
+ */
+ol.format.GML2.LINESTRINGORCURVEMEMBER_SERIALIZERS_ = {
+  'http://www.opengis.net/gml': {
+    'lineStringMember': ol.xml.makeChildAppender(
+        ol.format.GML2.prototype.writeLineStringOrCurveMember_),
+    'curveMember': ol.xml.makeChildAppender(
+        ol.format.GML2.prototype.writeLineStringOrCurveMember_)
+  }
+};
+
+
+/**
+ * @const
+ * @param {*} value Value.
+ * @param {Array.<*>} objectStack Object stack.
+ * @param {string=} opt_nodeName Node name.
+ * @return {Node|undefined} Node.
+ * @private
+ */
+ol.format.GML2.prototype.MULTIGEOMETRY_MEMBER_NODE_FACTORY_ = function(value, objectStack, opt_nodeName) {
+  var parentNode = objectStack[objectStack.length - 1].node;
+  return ol.xml.createElementNS('http://www.opengis.net/gml',
+      ol.format.GML2.MULTIGEOMETRY_TO_MEMBER_NODENAME_[parentNode.nodeName]);
+};
+
+/**
+ * @const
+ * @type {Object.<string, string>}
+ * @private
+ */
+ol.format.GML2.MULTIGEOMETRY_TO_MEMBER_NODENAME_ = {
+  'MultiLineString': 'lineStringMember',
+  'MultiCurve': 'curveMember',
+  'MultiPolygon': 'polygonMember',
+  'MultiSurface': 'surfaceMember'
+};
diff --git a/test/spec/ol/format/gml.test.js b/test/spec/ol/format/gml.test.js
index f046154..4d0093b 100644
--- a/test/spec/ol/format/gml.test.js
+++ b/test/spec/ol/format/gml.test.js
@@ -254,6 +254,37 @@ describe('ol.format.GML2', function() {
 
       expect(node).to.xmleql(ol.xml.parse(expected));
     });
+
+    it('can serialize a Multi Line String', function() {
+      var expected =
+        '<layer xmlns="http://www.openlayers.org/" fid="1">' +
+        '  <geometry>' +
+        '     <MultiLineString xmlns="http://www.opengis.net/gml" ' +
+        '                 srsName="EPSG:4326">' +
+        '       <lineStringMember>' +
+        '         <LineString srsName="EPSG:4326">' +
+        '           <coordinates ' +
+        '                    decimal="." cs="," ts=" ">' +
+        '              2,1.1 4.2,3' +
+        '           </coordinates>' +
+        '         </LineString>' +
+        '       </lineStringMember>' +
+        '      </MultiLineString>' +
+        '    </geometry>' +
+        '  </layer>';
+
+      var feature = new ol.Feature({
+        geometry: new ol.geom.MultiLineString([[[1.1, 2], [3, 4.2]]])
+      });
+      feature.setId(1);
+      var objectStack = [{
+        featureNS: featureNS,
+        srsName: 'EPSG:4326'
+      }];
+      format.writeFeatureElement(node, feature, objectStack);
+
+      expect(node).to.xmleql(ol.xml.parse(expected));
+    });
   });
 });
 
-- 
2.9.3

